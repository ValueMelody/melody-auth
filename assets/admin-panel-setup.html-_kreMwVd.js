import{_ as a,c as s,a as n,o as l}from"./app-h006SE9S.js";const i={};function r(d,e){return l(),s("div",null,e[0]||(e[0]=[n(`<h1 id="管理面板" tabindex="-1"><a class="header-anchor" href="#管理面板"><span>管理面板</span></a></h1><p>按照以下说明在本地或生产环境中设置并运行管理面板。</p><h2 id="_1-先决条件" tabindex="-1"><a class="header-anchor" href="#_1-先决条件"><span>1. 先决条件</span></a></h2><p>首先完成认证服务器的设置。</p><h2 id="_2-开始使用" tabindex="-1"><a class="header-anchor" href="#_2-开始使用"><span>2. 开始使用</span></a></h2><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">cd melody-auth/admin-panel</span>
<span class="line">cp .env.example .env</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-在-env-文件中更新以下变量" tabindex="-1"><a class="header-anchor" href="#_3-在-env-文件中更新以下变量"><span>3. 在 .env 文件中更新以下变量：</span></a></h2><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">NEXT_PUBLIC_CLIENT_URI: 设置为你的管理面板应用的主机 URL</span>
<span class="line">NEXT_PUBLIC_SERVER_URI: 设置为你的认证服务器的主机 URL</span>
<span class="line">NEXT_PUBLIC_CLIENT_ID: &quot;Admin Panel (SPA)&quot; 应用的 Client ID</span>
<span class="line">SERVER_CLIENT_ID: &quot;Admin Panel (S2S)&quot; 应用的 Client ID</span>
<span class="line">SERVER_CLIENT_SECRET: &quot;Admin Panel (S2S)&quot; 应用的 Client Secret</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>Cloudflare 远程/生产环境</strong>：在 Cloudflare 控制台的 “Workers &amp; Pages” -&gt; D1 -&gt; Melody Auth database -&gt; app 表中可以找到所需信息。</li><li><strong>Cloudflare 本地/开发环境</strong>：使用以下命令获取应用信息：<div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">cd melody-auth/server</span>
<span class="line">wrangler d1 execute melody-auth --command=&quot;select * from app&quot;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><strong>NodeJS 环境</strong>：在你的 Postgres melody-auth 数据库的 app 表中查看</li></ul><h2 id="_4-启动管理面板应用" tabindex="-1"><a class="header-anchor" href="#_4-启动管理面板应用"><span>4. 启动管理面板应用</span></a></h2><p>启动管理面板应用</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">cd melody-auth/admin-panel</span>
<span class="line">npm install</span>
<span class="line">npm run dev</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="初次设置" tabindex="-1"><a class="header-anchor" href="#初次设置"><span>初次设置</span></a></h3><ol><li>第一次访问管理面板时，你将被重定向到 auth 服务器登录页面。创建一个新账户。</li><li>创建账户后，你会被重定向回管理面板，并看到 “需要 super_admin 角色” 的提示。对于新账户来说这是正常的。</li><li>为了授予 super admin 访问权限： <ul><li><strong>Cloudflare 远程/生产环境</strong>： <ol><li>进入 Cloudflare 控制台</li><li>打开 “Workers &amp; Pages” -&gt; D1 -&gt; Melody Auth database -&gt; user_role 表</li><li>新增记录，设置 userId = 1 且 roleId = 1（假设你刚创建的是第一个用户）</li></ol></li><li><strong>Cloudflare 本地/开发环境</strong>：<div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">cd melody-auth/server</span>
<span class="line">wrangler d1 execute melody-auth --command=&quot;insert into user_role (userId, roleId) values (1, 1)&quot;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><strong>NodeJS 环境</strong>：在你的 Postgres melody-auth 数据库中插入以下记录：<div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">insert into user_role (userId, roleId) values (1, 1)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ul></li><li>登出（更新用户角色后必须）并重新登录。此时你应该拥有完整访问权限。</li></ol><h3 id="将管理面板部署到-cloudflare-workers" tabindex="-1"><a class="header-anchor" href="#将管理面板部署到-cloudflare-workers"><span>将管理面板部署到 Cloudflare Workers</span></a></h3><p>管理面板是一个全栈 Next.js 应用，通常部署在 Node.js 环境。现在通过 opennextjs-cloudflare 包支持部署到 Cloudflare Workers。</p><p><strong>注意</strong>：Cloudflare Workers 不能调用同一 Cloudflare 账户中的其他 Worker。因此，如果你计划同时在 Cloudflare 上部署管理面板和认证服务器，则必须为每个 Worker 分配一个自定义域名（例如 admin.example.com 与 auth.example.com），或将两个 Worker 部署到不同的 Cloudflare 账户，以避免此限制。</p><p>部署步骤：</p><ol><li><p>创建一个名为 “melody-auth-admin-panel” 的新 Worker</p></li><li><p>在 Cloudflare 控制台中进入 “melody-auth-admin-panel” -&gt; Settings -&gt; Variables and Secrets，添加以下 secrets</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">SERVER_CLIENT_ID=[&quot;Admin Panel (S2S)&quot; 应用的 Client ID]</span>
<span class="line">SERVER_CLIENT_SECRET=[&quot;Admin Panel (S2S)&quot; 应用的 Client Secret]</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>在项目根目录的 /admin-panel 文件夹下创建 .env 文件：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">NEXT_PUBLIC_CLIENT_URI=[此管理面板 Worker 的主机 URL]</span>
<span class="line">NEXT_PUBLIC_SERVER_URI=[你的认证服务器的主机 URL]</span>
<span class="line">NEXT_PUBLIC_CLIENT_ID=[&quot;Admin Panel (SPA)&quot; 应用的 Client ID]</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>进入 “Workers &amp; Pages” -&gt; D1 -&gt; Melody Auth database -&gt; app 表</p><ul><li>在 &quot;Admin Panel (SPA)&quot; 条目中，将 redirectUris 更新为 Cloudflare 地址（例如 https://melody-auth-admin.[your-account-name].workers.dev）</li></ul></li><li><p>构建项目</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">npm run cf:build</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>部署</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">npm run cf:deploy</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ol><h2 id="为管理面板配置自定义角色访问" tabindex="-1"><a class="header-anchor" href="#为管理面板配置自定义角色访问"><span>为管理面板配置自定义角色访问</span></a></h2><p>默认情况下，管理面板只接受 super_admin 角色登录。若要使用具有受限权限的自定义角色登录，请执行以下步骤：</p><ol><li>在 /admin-panel/tools/access 中，将你的自定义角色添加到 <strong>AllowedRoles</strong> 数组。</li><li>在 <strong>RoleAccesses</strong> 中为你的自定义角色定义访问权限，文件位置同上 (/admin-panel/tools/access)。</li></ol>`,22)]))}const o=a(i,[["render",r]]),p=JSON.parse('{"path":"/zh/admin-panel-setup.html","title":"管理面板","lang":"zh-CN","frontmatter":{},"git":{"updatedTime":1748744819000,"contributors":[{"name":"Baozier","username":"Baozier","email":"byn9826@gmail.com","commits":1,"url":"https://github.com/Baozier"}],"changelog":[{"hash":"1f6a42a6b45fdfb25e862e4b91e0a9988ee80459","time":1748744819000,"email":"byn9826@gmail.com","author":"Baozier","message":"Add docs in CN (#378)"}]},"filePathRelative":"zh/admin-panel-setup.md"}');export{o as comp,p as data};
