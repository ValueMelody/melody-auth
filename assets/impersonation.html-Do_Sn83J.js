import{_ as s,c as a,a as e,o as p}from"./app-BMtGzWFk.js";const o={};function t(i,n){return p(),a("div",null,n[0]||(n[0]=[e(`<h1 id="模拟登录-impersonation" tabindex="-1"><a class="header-anchor" href="#模拟登录-impersonation"><span>模拟登录（Impersonation）</span></a></h1><p>允许具有特权的管理员在特定应用中以其他用户身份操作，用于支持与问题排查。</p><h2 id="工作原理" tabindex="-1"><a class="header-anchor" href="#工作原理"><span>工作原理</span></a></h2><ul><li>具有允许角色的管理员为目标用户和 SPA 应用触发模拟登录。</li><li>服务器为目标用户签发一个短期有效的 refresh_token，并将其归属于模拟执行者。</li><li>前端使用该 refresh_token 获取目标用户会话的 access token。</li></ul><p>注意：</p><ul><li>仅支持 SPA 应用进行模拟登录。</li><li>如果应用要求用户授权，目标用户必须已授权，否则请求将被拒绝。</li></ul><h2 id="服务器端角色配置" tabindex="-1"><a class="header-anchor" href="#服务器端角色配置"><span>服务器端角色配置</span></a></h2><p>文件：<code>server/src/configs/variable.ts</code></p><ul><li>将允许进行模拟的自定义角色添加到 <code>S2sConfig.impersonationRoles</code>。</li><li>默认值为 <code>[Role.SuperAdmin]</code>。</li></ul><p>示例：</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> S2sConfig <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  impersonationRoles<span class="token operator">:</span> <span class="token punctuation">[</span>Role<span class="token punctuation">.</span>SuperAdmin<span class="token punctuation">,</span> Role<span class="token punctuation">.</span>SupportAdmin<span class="token punctuation">,</span> Role<span class="token punctuation">.</span>OrgAdmin<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改后请重新部署或重启认证服务器。</p><h2 id="admin-panel-访问控制配置" tabindex="-1"><a class="header-anchor" href="#admin-panel-访问控制配置"><span>Admin Panel 访问控制配置</span></a></h2><p>文件：<code>admin-panel/tools/access.ts</code></p><p>要让自定义角色在 Admin Panel 中使用模拟功能：</p><ul><li>将角色添加到 <code>AllowedRoles</code>。</li><li>在 <code>RoleAccesses[YourRole]</code> 中添加 <code>Access.Impersonation</code>。通常还需要添加基础读取权限（如 <code>ReadUser</code>、<code>ReadApp</code>）。</li></ul><p>示例：</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> AllowedRoles <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">  typeTool<span class="token punctuation">.</span>Role<span class="token punctuation">.</span>SuperAdmin<span class="token punctuation">,</span></span>
<span class="line">  typeTool<span class="token punctuation">.</span>Role<span class="token punctuation">.</span>SupportAdmin<span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> RoleAccesses <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token punctuation">[</span>typeTool<span class="token punctuation">.</span>Role<span class="token punctuation">.</span>SuperAdmin<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token comment">// ...已有权限</span></span>
<span class="line">    Access<span class="token punctuation">.</span>Impersonation<span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span>typeTool<span class="token punctuation">.</span>Role<span class="token punctuation">.</span>SupportAdmin<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    Access<span class="token punctuation">.</span>ReadUser<span class="token punctuation">,</span></span>
<span class="line">    Access<span class="token punctuation">.</span>ReadApp<span class="token punctuation">,</span></span>
<span class="line">    Access<span class="token punctuation">.</span>Impersonation<span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>确保管理员账户已被分配到正确的角色。</p><h2 id="在-admin-panel-中使用" tabindex="-1"><a class="header-anchor" href="#在-admin-panel-中使用"><span>在 Admin Panel 中使用</span></a></h2><ul><li>打开用户详情页并选择“Impersonate”。</li><li>选择一个 SPA 应用。如果需要用户同意且缺少同意，将提示先获取同意。</li><li>成功后，你将收到一个 <code>refresh_token</code>，以及每个应用重定向 URI 的便捷链接： <ul><li><code>https://your-app.example.com/callback?refresh_token=...&amp;refresh_token_expires_on=...&amp;refresh_token_expires_in=...</code></li></ul></li></ul><p>点击链接会打开已预加载模拟 refresh token 的应用。<br><img src="https://raw.githubusercontent.com/ValueMelody/melody-auth/main/docs/images/impersonation.jpg" alt="Impersonation"></p><h2 id="前端对模拟的处理" tabindex="-1"><a class="header-anchor" href="#前端对模拟的处理"><span>前端对模拟的处理</span></a></h2><p>所有前端 SDK 会在加载时自动解析 <code>refresh_token</code> 查询参数并存储。</p><h2 id="直接调用-s2s-api" tabindex="-1"><a class="header-anchor" href="#直接调用-s2s-api"><span>直接调用 S2S API</span></a></h2><p>如果需要自行生成模拟登录的 refresh token，可以直接调用 S2S API。</p><p>端点：<code>POST /api/v1/users/{authId}/impersonation/{appId}</code></p><ul><li>Authorization：使用带有 <code>root</code> scope 的 S2S token</li><li>Body：<code>{ &quot;impersonatorToken&quot;: &quot;&lt;admin-spa-access-token&gt;&quot; }</code></li><li>Response：<code>{ refresh_token, refresh_token_expires_in, refresh_token_expires_on }</code></li></ul><p>步骤：</p><ol><li>使用 Client Credentials 并带 <code>root</code> scope 获取 S2S access token。</li><li>使用该 token 调用上述端点。</li><li>将返回的 <code>refresh_token</code> 通过重定向 URL 参数提供给目标应用。</li><li>应用可使用 refresh token 获取目标用户会话的 access token。</li></ol><h2 id="安全注意事项" tabindex="-1"><a class="header-anchor" href="#安全注意事项"><span>安全注意事项</span></a></h2><ul><li>模拟登录应仅限可信的管理员角色使用。</li><li>Token 默认短期有效，返回的 refresh token 有效期约 30 分钟。</li><li>refresh token 内部带有 <code>impersonatedBy</code> 标签以便追踪。</li></ul>`,32)]))}const c=s(o,[["render",t]]),r=JSON.parse('{"path":"/zh/impersonation.html","title":"模拟登录（Impersonation）","lang":"zh-CN","frontmatter":{},"git":{"updatedTime":1754954867000,"contributors":[{"name":"Baozier","username":"Baozier","email":"byn9826@gmail.com","commits":1,"url":"https://github.com/Baozier"}],"changelog":[{"hash":"8072502fc071765c4d8e2ab6e797919d78d7c086","time":1754954867000,"email":"byn9826@gmail.com","author":"Baozier","message":"Regroup docs (#420)"}]},"filePathRelative":"zh/impersonation.md"}');export{c as comp,r as data};
