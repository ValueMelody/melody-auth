import{_ as s,c as n,a as e,o as l}from"./app-C2vUhxwJ.js";const p={};function i(c,a){return l(),n("div",null,a[0]||(a[0]=[e(`<h1 id="多重认证-mfa-设置" tabindex="-1"><a class="header-anchor" href="#多重认证-mfa-设置"><span>多重认证（MFA）设置</span></a></h1><p>MFA 在你的主要登录方式上增加了一层额外的安全保护。Melody Auth 支持 Email、OTP（TOTP）和 SMS MFA，以及相关功能，例如 Passkey、Recovery Codes 和 Remember Device。</p><h2 id="在服务器层面配置-mfa" tabindex="-1"><a class="header-anchor" href="#在服务器层面配置-mfa"><span>在服务器层面配置 MFA</span></a></h2><p>在 <code>server/wrangler.toml</code> 中配置以下环境变量：</p><div class="language-toml line-numbers-mode" data-highlighter="prismjs" data-ext="toml"><pre><code class="language-toml"><span class="line"><span class="token comment"># 在登录时强制使用特定的 MFA 方式</span></span>
<span class="line"><span class="token key property">OTP_MFA_IS_REQUIRED</span><span class="token punctuation">=</span><span class="token boolean">false</span></span>
<span class="line"><span class="token key property">EMAIL_MFA_IS_REQUIRED</span><span class="token punctuation">=</span><span class="token boolean">false</span> <span class="token comment"># 需要已配置邮箱服务提供商</span></span>
<span class="line"><span class="token key property">SMS_MFA_IS_REQUIRED</span><span class="token punctuation">=</span><span class="token boolean">false</span>   <span class="token comment"># 需要已配置短信服务提供商</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 当所有 *_IS_REQUIRED=false 时，强制至少注册一个允许的 MFA 方式</span></span>
<span class="line"><span class="token key property">ENFORCE_ONE_MFA_ENROLLMENT</span><span class="token punctuation">=</span><span class="token punctuation">[</span><span class="token string">&#39;otp&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;email&#39;</span><span class="token punctuation">]</span> <span class="token comment"># 选项: &#39;email&#39;, &#39;otp&#39;, &#39;sms&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 当主 MFA 方式不可用时，允许 Email MFA 作为备用方式</span></span>
<span class="line"><span class="token key property">ALLOW_EMAIL_MFA_AS_BACKUP</span><span class="token punctuation">=</span><span class="token boolean">true</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 相关功能</span></span>
<span class="line"><span class="token key property">ALLOW_PASSKEY_ENROLLMENT</span><span class="token punctuation">=</span><span class="token boolean">false</span>   <span class="token comment"># 启用 passkey 注册流程</span></span>
<span class="line"><span class="token key property">ENABLE_RECOVERY_CODE</span><span class="token punctuation">=</span><span class="token boolean">false</span>       <span class="token comment"># 启用恢复代码</span></span>
<span class="line"><span class="token key property">ENABLE_MFA_REMEMBER_DEVICE</span><span class="token punctuation">=</span><span class="token boolean">false</span> <span class="token comment"># 允许用户记住设备 30 天</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>如果 OTP_MFA_IS_REQUIRED、EMAIL_MFA_IS_REQUIRED 或 SMS_MFA_IS_REQUIRED 中的任何一个为 true，则该 MFA 方式在登录时是必需的。</li><li>当三者都为 false 时，ENFORCE_ONE_MFA_ENROLLMENT 可以要求用户至少注册一个允许列表中的 MFA 方式。</li><li>在启用相应的 MFA 类型之前，请先配置 Email/SMS 服务提供商。</li></ul><h2 id="注册方式" tabindex="-1"><a class="header-anchor" href="#注册方式"><span>注册方式</span></a></h2><ul><li>Admin Panel：管理员可以注册或取消注册 MFA，并管理恢复选项。</li><li>S2S API：从后端以编程方式驱动注册流程。</li><li>Embedded Auth API：从前端以编程方式驱动注册流程。</li></ul><h2 id="passkey" tabindex="-1"><a class="header-anchor" href="#passkey"><span>Passkey</span></a></h2><p>Passkey 提供安全、防钓鱼的无密码登录，并允许用户跳过 MFA。启用方式：</p><ul><li>将 ALLOW_PASSKEY_ENROLLMENT 设置为 true</li></ul><h2 id="recovery-codes" tabindex="-1"><a class="header-anchor" href="#recovery-codes"><span>Recovery codes</span></a></h2><p>Recovery codes 允许用户在忘记密码或无法完成 MFA 时重新获得访问权限。</p><ul><li>将 ENABLE_RECOVERY_CODE 设置为 true</li></ul><h2 id="记住此设备-30-天" tabindex="-1"><a class="header-anchor" href="#记住此设备-30-天"><span>记住此设备（30 天）</span></a></h2><p>用户可以选择在受信任设备上跳过 30 天的 MFA 验证。</p><ul><li>将 ENABLE_MFA_REMEMBER_DEVICE 设置为 true</li></ul><h2 id="应用层面的-mfa-配置" tabindex="-1"><a class="header-anchor" href="#应用层面的-mfa-配置"><span>应用层面的 MFA 配置</span></a></h2><p>可以针对每个应用（client）单独配置 MFA 行为，而不是全局配置。</p><ul><li>Admin Panel：打开目标应用并配置 MFA 要求（例如必需因子、Email 作为备份）。</li><li>S2S API：以编程方式更新应用的 MFA 配置。</li></ul><p>当不同应用需要不同的安全等级时（例如，内部管理应用需要更严格的 MFA）非常有用。然而，这项设置与 ENFORCE_ONE_MFA_ENROLLMENT 设置冲突，因此你需要仔细考虑其影响。 <img src="https://raw.githubusercontent.com/ValueMelody/melody-auth/main/docs/images/app_level_mfa.jpg" alt="App-level MFA"></p><h2 id="相关-policy-快捷方式" tabindex="-1"><a class="header-anchor" href="#相关-policy-快捷方式"><span>相关 policy（快捷方式）</span></a></h2><p>你可以通过 policy 直接跳转到特定流程：</p><ul><li><code>reset_mfa</code>：重置已注册的 MFA</li><li><code>manage_recovery_code</code>：管理恢复代码</li><li><code>manage_passkey</code>：管理 passkey</li></ul>`,24)]))}const t=s(p,[["render",i]]),r=JSON.parse('{"path":"/zh/mfa-setup.html","title":"多重认证（MFA）设置","lang":"zh-CN","frontmatter":{},"git":{"updatedTime":1754954867000,"contributors":[{"name":"Baozier","username":"Baozier","email":"byn9826@gmail.com","commits":1,"url":"https://github.com/Baozier"}],"changelog":[{"hash":"8072502fc071765c4d8e2ab6e797919d78d7c086","time":1754954867000,"email":"byn9826@gmail.com","author":"Baozier","message":"Regroup docs (#420)"}]},"filePathRelative":"zh/mfa-setup.md"}');export{t as comp,r as data};
